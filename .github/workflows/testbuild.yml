
name: Build and Test Docker Images

on:
  push:
    branches:
      - '**'
    paths:
      - "samples/**"
  pull_request:
    paths:
      - "samples/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-CiTest
  cancel-in-progress: true

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: email
            context: samples/GCP/EmailProcessing
            tag: adktemplate:latest
            test_cmd: |
              docker run --rm -d -p 8080:8080 "$IMAGE_TAG"
              # wait briefly for startup and check health
              sleep 10
              curl -sSf localhost:8080/status

          - name: finance_sample
            context: samples/GCP/FinanceProcessing
            tag: adksample:latest
            test_cmd: |
              # Ensure sample.txt exists (harmless if already present)
              test -f sample.txt || echo "demo" > sample.txt
              docker run --rm -v "$(pwd)/sample.txt":/app/sample.txt "$IMAGE_TAG" -f sample.txt

          - name: finance_adk
            context: samples/GCP/FinanceADK
            tag: adkfinance:latest
            test_cmd: |
              docker run --rm "$IMAGE_TAG"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build Docker image - ${{ matrix.name }}
        working-directory: ${{ matrix.context }}
        env:
          IMAGE_TAG: ${{ matrix.tag }}
        run: |
          docker build . --file Dockerfile --tag "$IMAGE_TAG"

      - name: Run container/tests - ${{ matrix.name }}
        working-directory: ${{ matrix.context }}
        env:
          IMAGE_TAG: ${{ matrix.tag }}
        run: ${{ matrix.test_cmd }}

      # Trivy vulnerability scan (informational only)
      - name: Trivy scan - ${{ matrix.tag }} (non-fatal)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ matrix.tag }}
          format: 'table'
          exit-code: '0'           # do not fail the job on findings
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Stop containers (if any)
        if: always()
        run: |
          CONTAINERS=$(docker ps -q)
          if [ -n "$CONTAINERS" ]; then
            docker stop $CONTAINERS
          else
            echo "No running containers to stop."
          fi

